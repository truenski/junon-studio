---
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import CodeBlock from "./CodeBlock.astro";
import ExampleBlock from "./ExampleBlock.astro";

interface Props {
  id: string;
  title: string;
  category?: string;
  description: string;
  content: CollectionEntry<"commands" | "triggers" | "actions" | "functions" | "variables" | "mobs" | "entities">;
  type: "command" | "trigger" | "action" | "function" | "variable" | "mob" | "entity";
}

const { id, title, category, description, content, type } = Astro.props;
const { Content } = await render(content);
const { data } = content;

// Build comprehensive searchable text
let searchableText = `${title} ${description}`.toLowerCase();
if (type === "command" && "syntax" in data) {
  searchableText += " " + (data.syntax || []).join(" ").toLowerCase();
  searchableText += " " + (data.args || []).map((a: any) => `${a.name} ${a.type} ${a.description}`).join(" ").toLowerCase();
  searchableText += " " + (data.examples || []).map((e: any) => `${e.code} ${e.description}`).join(" ").toLowerCase();
  if (data.category) searchableText += " " + data.category.toLowerCase();
} else if (type === "trigger" && "variables" in data) {
  searchableText += " " + (data.variables || []).map((v: any) => `${v.name} ${v.type} ${v.description}`).join(" ").toLowerCase();
  searchableText += " " + (data.examples || []).map((e: any) => `${e.code} ${e.description}`).join(" ").toLowerCase();
} else if (type === "action" && "syntax" in data) {
  searchableText += " " + (data.syntax || []).join(" ").toLowerCase();
  searchableText += " " + (data.examples || []).map((e: any) => `${e.code} ${e.description}`).join(" ").toLowerCase();
} else if (type === "function") {
  if (data.syntax) searchableText += " " + data.syntax.toLowerCase();
  searchableText += " " + (data.parameters || []).map((p: any) => `${p.name} ${p.type} ${p.description}`).join(" ").toLowerCase();
  if (data.returns) searchableText += " " + data.returns.toLowerCase();
  searchableText += " " + (data.examples || []).map((e: any) => `${e.code} ${e.description}`).join(" ").toLowerCase();
} else if (type === "variable") {
  if (data.type) searchableText += " " + data.type.toLowerCase();
  searchableText += " " + (data.examples || []).map((e: any) => `${e.code} ${e.description}`).join(" ").toLowerCase();
} else if (type === "mob" || type === "entity") {
  searchableText += " " + (data.properties || []).map((p: any) => `${p.name} ${p.value}`).join(" ").toLowerCase();
  if (type === "entity" && data.type) searchableText += " " + data.type.toLowerCase();
  searchableText += " " + (data.examples || []).map((e: any) => `${e.code} ${e.description}`).join(" ").toLowerCase();
}
---

<div
  id={`accordion-${type}-${id}`}
  class="accordion-item border border-white/10 rounded mb-2 overflow-hidden transition-all duration-300 opacity-100 scale-100"
  data-id={id}
  data-type={type}
  data-category={category || ""}
  data-title={title.toLowerCase()}
  data-description={description.toLowerCase()}
  data-searchable={searchableText}
>
  <button
    class="accordion-header w-full px-4 py-3 text-left hover:bg-white/5 transition-colors flex items-center justify-between group"
    data-accordion-toggle={id}
    type="button"
  >
    <div class="flex-1">
      <div class="flex items-center gap-3">
        <h3 class="text-lg font-bold group-hover:text-white transition-colors">
          {title}
        </h3>
        {category && (
          <span class="text-xs uppercase text-white/50 bg-white/5 px-2 py-1 rounded">
            {category}
          </span>
        )}
      </div>
      <p class="text-sm text-white/70 mt-1">{description}</p>
    </div>
    <svg
      class="accordion-icon w-5 h-5 text-white/50 transform transition-transform duration-300"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 9l-7 7-7-7"
      />
    </svg>
  </button>
  <div
    class="accordion-content max-h-0 overflow-hidden transition-all duration-300"
    data-accordion-content={id}
  >
    <div class="px-4 py-4 border-t border-white/10 bg-black/50">
      {type === "command" && "syntax" in data && data.syntax && data.syntax.length > 0 && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Syntax</h2>
          {data.syntax.map((syntax: string) => (
            <div class="mb-2">
              <CodeBlock code={syntax} />
            </div>
          ))}
        </div>
      )}

      {type === "command" && "args" in data && data.args && data.args.length > 0 && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Arguments</h2>
          <div class="space-y-2">
            {data.args.map((arg: any) => (
              <div class="border border-white/10 rounded p-3">
                <div class="flex items-center gap-2 mb-1">
                  <code class="text-sm font-mono">{arg.name}</code>
                  <span class="text-xs text-white/50">({arg.type})</span>
                  {arg.required && (
                    <span class="text-xs bg-white/10 px-2 py-0.5 rounded">required</span>
                  )}
                </div>
                <p class="text-sm text-white/70">{arg.description}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {type === "trigger" && "variables" in data && data.variables && data.variables.length > 0 && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Variables</h2>
          <div class="space-y-2">
            {data.variables.map((variable: any) => (
              <div class="border border-white/10 rounded p-3">
                <div class="flex items-center gap-2 mb-1">
                  <code class="text-sm font-mono">${variable.name}</code>
                  <span class="text-xs text-white/50">({variable.type})</span>
                </div>
                <p class="text-sm text-white/70">{variable.description}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {type === "function" && "parameters" in data && data.parameters && data.parameters.length > 0 && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Parameters</h2>
          <div class="space-y-2">
            {data.parameters.map((param: any) => (
              <div class="border border-white/10 rounded p-3">
                <div class="flex items-center gap-2 mb-1">
                  <code class="text-sm font-mono">{param.name}</code>
                  <span class="text-xs text-white/50">({param.type})</span>
                  {param.required && (
                    <span class="text-xs bg-white/10 px-2 py-0.5 rounded">required</span>
                  )}
                </div>
                <p class="text-sm text-white/70">{param.description}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {type === "function" && "syntax" in data && data.syntax && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Syntax</h2>
          <CodeBlock code={data.syntax} />
        </div>
      )}

      {type === "function" && "returns" in data && data.returns && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Returns</h2>
          <p class="text-white/80">{data.returns}</p>
        </div>
      )}

      {"examples" in data && data.examples && data.examples.length > 0 && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Examples</h2>
          {data.examples.map((example: any) => (
            <ExampleBlock code={example.code} description={example.description} />
          ))}
        </div>
      )}

      {"properties" in data && data.properties && data.properties.length > 0 && (
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-3">Properties</h2>
          <div class="space-y-2">
            {data.properties.map((prop: any) => (
              <div class="border border-white/10 rounded p-3">
                <div class="flex items-center gap-2 mb-1">
                  <code class="text-sm font-mono">{prop.name}</code>
                </div>
                <p class="text-sm text-white/70">{prop.value}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      <div class="prose prose-invert max-w-none">
        <Content />
      </div>
    </div>
  </div>
</div>

<style>
  .accordion-item {
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    transition-delay: calc(var(--index, 0) * 0.02s);
  }
  
  .accordion-item.hidden {
    opacity: 0 !important;
    transform: scale(0.95) translateY(-8px) !important;
    pointer-events: none;
  }
</style>

<script>
  // Function to open/close accordion programmatically
  function toggleAccordion(itemId: string, open: boolean = true) {
    const content = document.querySelector(`[data-accordion-content="${itemId}"]`) as HTMLElement;
    const toggle = document.querySelector(`[data-accordion-toggle="${itemId}"]`) as HTMLElement;
    const icon = toggle?.querySelector(".accordion-icon") as HTMLElement;
    const item = toggle?.closest(".accordion-item") as HTMLElement;
    
    if (!content || !toggle) return;
    
    const isOpen = !content.classList.contains("max-h-0");
    
    if (open && !isOpen) {
      // Open
      content.classList.remove("max-h-0");
      content.classList.add("max-h-[5000px]");
      icon?.classList.add("rotate-180");
      item?.classList.add("bg-white/5");
      
      // Update URL hash
      const type = item?.getAttribute("data-type");
      if (type) {
        window.history.replaceState(null, "", `#${type}-${itemId}`);
      }
    } else if (!open && isOpen) {
      // Close
      content.classList.remove("max-h-[5000px]");
      content.classList.add("max-h-0");
      icon?.classList.remove("rotate-180");
      item?.classList.remove("bg-white/5");
    }
  }
  
  // Make function globally available
  (window as any).toggleAccordion = toggleAccordion;
  
  document.addEventListener("DOMContentLoaded", () => {
    const toggles = document.querySelectorAll("[data-accordion-toggle]");
    
    toggles.forEach((toggle) => {
      toggle.addEventListener("click", () => {
        const itemId = toggle.getAttribute("data-accordion-toggle");
        if (!itemId) return;
        
        const content = document.querySelector(`[data-accordion-content="${itemId}"]`) as HTMLElement;
        const icon = toggle.querySelector(".accordion-icon") as HTMLElement;
        const item = toggle.closest(".accordion-item") as HTMLElement;
        
        if (!content) return;
        
        const isOpen = !content.classList.contains("max-h-0");
        toggleAccordion(itemId, !isOpen);
      });
    });
    
    // Check for hash on load
    if (window.location.hash) {
      const hash = window.location.hash.substring(1); // Remove #
      const [type, ...idParts] = hash.split("-");
      const itemId = idParts.join("-");
      
      // Wait a bit for items to render
      setTimeout(() => {
        const targetItem = document.querySelector(`#accordion-${type}-${itemId}`);
        if (targetItem) {
          // Ensure item is visible (remove filters if needed)
          targetItem.classList.remove("hidden");
          (targetItem as HTMLElement).style.display = "block";
          
          // Scroll to item
          targetItem.scrollIntoView({ behavior: "smooth", block: "start" });
          
          // Open accordion
          setTimeout(() => {
            toggleAccordion(itemId, true);
          }, 100);
        }
      }, 300);
    }
  });
  
  // Listen for hash changes
  window.addEventListener("hashchange", () => {
    if (window.location.hash) {
      const hash = window.location.hash.substring(1);
      const [type, ...idParts] = hash.split("-");
      const itemId = idParts.join("-");
      
      const targetItem = document.querySelector(`#accordion-${type}-${itemId}`);
      if (targetItem) {
        targetItem.scrollIntoView({ behavior: "smooth", block: "start" });
        setTimeout(() => {
          toggleAccordion(itemId, true);
        }, 100);
      }
    }
  });
</script>
